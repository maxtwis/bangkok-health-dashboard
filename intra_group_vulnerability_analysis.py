"""
Chapter 4.2: Intra-Group Vulnerability Analysis
Deep-dive statistical analysis to identify determinants of vulnerability WITHIN each population group

IMPORTANT: Uses INCLUSIVE FILTERING (no mutually exclusive priority)
- Individuals can appear in multiple groups
- Example: Elderly disabled LGBTQ+ person analyzed in all 3 groups

Analysis Groups:
1. Elderly (age >= 60): Health Outcomes & Social Context by Age Group and Living Arrangement
2. Disabled (disable_status == 1): Economic Security by Education Level
3. Informal Workers (occupation_status == 1 AND occupation_contract == 0):
   Economic Security & Healthcare Access by Income Quartiles and Education
4. LGBTQ+ (sex == 'lgbt'): Healthcare Access & Social Context by Generation
"""

import pandas as pd
import numpy as np
from scipy import stats
from scipy.stats import f_oneway, levene, ttest_ind
import warnings
warnings.filterwarnings('ignore')

print("="*80)
print("INTRA-GROUP VULNERABILITY ANALYSIS")
print("Using Inclusive Filtering Logic")
print("="*80)

# ============================================================================
# STEP 1: Load Data and Calculate Domain Scores
# ============================================================================

print("\nStep 1: Loading data and calculating domain scores...")

# Load survey data
survey_df = pd.read_csv('public/data/survey_sampling.csv', encoding='utf-8-sig')
print(f"Survey data loaded: {len(survey_df)} respondents")

# Import domain score calculation from main analysis
# (Reuse the same scoring logic for consistency)

def calculate_income(row):
    """Calculate monthly income"""
    if pd.isna(row.get('income', None)) or row.get('income', 0) == 0:
        return np.nan
    if row.get('income_type', 2) == 1:
        return row['income'] * 30
    else:
        return row['income']

def calculate_bmi(row):
    """Calculate BMI"""
    height = row.get('height', 0)
    weight = row.get('weight', 0)
    if height > 0 and weight > 0:
        return weight / ((height / 100) ** 2)
    return np.nan

def normalize_score(value, min_val, max_val, reverse=False):
    """Normalize score to 0-100 scale"""
    if pd.isna(value):
        return np.nan
    if max_val == min_val:
        return 50.0
    normalized = ((value - min_val) / (max_val - min_val)) * 100
    if reverse:
        normalized = 100 - normalized
    return np.clip(normalized, 0, 100)

# Calculate helper variables
survey_df['monthly_income'] = survey_df.apply(calculate_income, axis=1)
survey_df['bmi'] = survey_df.apply(calculate_bmi, axis=1)

print("  - Calculating domain scores (reusing methodology from main analysis)...")

# Import all domain score calculations from population_group_inequality_analysis.py
# Economic Security, Healthcare Access, Physical Environment, Social Context, Health Behaviors, Health Outcomes

# ECONOMIC SECURITY
survey_df['employment_score'] = survey_df['occupation_status'].apply(lambda x: 100 if x == 1 else 0)

def vulnerable_employment_score(row):
    if row.get('occupation_status', 0) == 1:
        has_contract = row.get('occupation_contract', 0) == 1
        has_welfare = row.get('occupation_welfare', 0) == 1
        if has_contract and has_welfare:
            return 100
        elif has_contract or has_welfare:
            return 50
        else:
            return 0
    return np.nan

survey_df['vulnerable_employment_score'] = survey_df.apply(vulnerable_employment_score, axis=1)

survey_df['food_security_score'] = survey_df.apply(
    lambda row: 100 if row.get('food_insecurity_1', 0) == 0 and row.get('food_insecurity_2', 0) == 0
    else 50 if row.get('food_insecurity_1', 0) == 1 and row.get('food_insecurity_2', 0) == 0
    else 0, axis=1
)

survey_df['work_injury_score'] = survey_df.apply(
    lambda row: 100 if row.get('occupation_injury', 0) == 0 else 0, axis=1
)

income_values = survey_df['monthly_income'].dropna()
if len(income_values) > 0:
    survey_df['income_score'] = survey_df['monthly_income'].apply(
        lambda x: normalize_score(x, income_values.min(), income_values.max())
    )
else:
    survey_df['income_score'] = np.nan

def health_spending_burden(row):
    income = row.get('monthly_income', 0)
    health_exp = row.get('hh_health_expense', 0)
    if income > 0 and pd.notna(health_exp):
        ratio = health_exp / income
        if ratio > 0.25:
            return 0
        elif ratio > 0.10:
            return 50
        else:
            return 100
    return np.nan

survey_df['health_spending_score'] = survey_df.apply(health_spending_burden, axis=1)

survey_df['economic_security_score'] = survey_df[[
    'employment_score', 'vulnerable_employment_score', 'food_security_score',
    'work_injury_score', 'income_score', 'health_spending_score'
]].mean(axis=1)

# HEALTHCARE ACCESS
survey_df['health_coverage_score'] = survey_df['welfare'].apply(
    lambda x: 100 if x in [1, 2, 3] else 0
)

survey_df['medical_access_score'] = survey_df['medical_skip_1'].apply(
    lambda x: 0 if x == 1 else 100
)

def dental_access_score(row):
    if row.get('oral_health', 0) == 1:
        return 100 if row.get('oral_health_access', 0) == 1 else 0
    return 100

survey_df['dental_access_score'] = survey_df.apply(dental_access_score, axis=1)

survey_df['healthcare_access_score'] = survey_df[[
    'health_coverage_score', 'medical_access_score', 'dental_access_score'
]].mean(axis=1)

# SOCIAL CONTEXT
survey_df['safety_score'] = survey_df['community_safety'].apply(
    lambda x: ((x - 1) / 3) * 100 if pd.notna(x) else np.nan
)

survey_df['violence_score'] = survey_df.apply(
    lambda row: 100 if row.get('physical_violence', 0) == 0 and
                      row.get('psychological_violence', 0) == 0 and
                      row.get('sexual_violence', 0) == 0
    else 67 if (row.get('physical_violence', 0) + row.get('psychological_violence', 0) +
                row.get('sexual_violence', 0)) == 1
    else 33 if (row.get('physical_violence', 0) + row.get('psychological_violence', 0) +
                row.get('sexual_violence', 0)) == 2
    else 0, axis=1
)

survey_df['discrimination_score'] = survey_df['discrimination_1'].apply(
    lambda x: 0 if x == 1 else 100
)

survey_df['social_support_score'] = survey_df['helper'].apply(
    lambda x: 100 if x == 1 else 0
)

survey_df['social_context_score'] = survey_df[[
    'safety_score', 'violence_score', 'discrimination_score', 'social_support_score'
]].mean(axis=1)

# HEALTH OUTCOMES
survey_df['chronic_disease_score'] = survey_df['diseases_status'].apply(
    lambda x: 0 if x == 1 else 100
)

disease_columns = [f'diseases_type_{i}' for i in range(1, 22)]
def count_diseases(row):
    count = 0
    for col in disease_columns:
        if row.get(col, 0) == 1:
            count += 1
    return count

survey_df['disease_count'] = survey_df.apply(count_diseases, axis=1)

survey_df['disease_burden_score'] = survey_df['disease_count'].apply(
    lambda x: 100 if x == 0 else 75 if x == 1 else 50 if x == 2 else 25 if x == 3 else 0
)

survey_df['health_outcomes_score'] = survey_df[[
    'chronic_disease_score', 'disease_burden_score'
]].mean(axis=1)

print("  - All domain scores calculated successfully.")

# ============================================================================
# STEP 2: Define Inclusive Filters for Each Group
# ============================================================================

print("\nStep 2: Creating inclusive group filters...")

# INCLUSIVE FILTERS - respondents can belong to multiple groups

# 1. Elderly
survey_df['is_elderly'] = survey_df['age'] >= 60

# 2. Disabled
survey_df['is_disabled'] = survey_df['disable_status'] == 1

# 3. Informal Workers
survey_df['is_informal'] = (survey_df['occupation_status'] == 1) & (survey_df['occupation_contract'] == 0)

# 4. LGBTQ+
survey_df['is_lgbt'] = survey_df['sex'] == 'lgbt'

print(f"\nInclusive group sizes:")
print(f"  - Elderly (age >= 60): {survey_df['is_elderly'].sum():,}")
print(f"  - Disabled: {survey_df['is_disabled'].sum():,}")
print(f"  - Informal Workers: {survey_df['is_informal'].sum():,}")
print(f"  - LGBTQ+: {survey_df['is_lgbt'].sum():,}")

# ============================================================================
# ANALYSIS 1: ELDERLY GROUP
# ============================================================================

print("\n" + "="*80)
print("ANALYSIS 1: ELDERLY GROUP (age >= 60)")
print("="*80)

elderly_df = survey_df[survey_df['is_elderly']].copy()
print(f"Total elderly respondents: {len(elderly_df):,}")

# 1.1 Age Groups
elderly_df['age_group'] = pd.cut(elderly_df['age'],
                                  bins=[59, 69, 79, 120],
                                  labels=['60-69', '70-79', '80+'])

# 1.2 Living Arrangement
elderly_df['living_arrangement'] = elderly_df['family_status'].apply(
    lambda x: 'With Family' if x == 1 else 'Living Alone'
)

print("\nAge group distribution:")
print(elderly_df['age_group'].value_counts())
print("\nLiving arrangement distribution:")
print(elderly_df['living_arrangement'].value_counts())

# Test 1.1: Health Outcomes by Age Group
print("\n" + "-"*80)
print("Test 1.1: Health Outcomes by Age Group (One-way ANOVA)")
print("-"*80)

groups_age = [elderly_df[elderly_df['age_group'] == ag]['health_outcomes_score'].dropna()
              for ag in ['60-69', '70-79', '80+']]
f_stat, p_value = f_oneway(*groups_age)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by age group:")
    for ag in ['60-69', '70-79', '80+']:
        mean_score = elderly_df[elderly_df['age_group'] == ag]['health_outcomes_score'].mean()
        print(f"  {ag}: {mean_score:.2f}")

# Test 1.2: Health Outcomes by Living Arrangement
print("\n" + "-"*80)
print("Test 1.2: Health Outcomes by Living Arrangement (T-Test)")
print("-"*80)

alone = elderly_df[elderly_df['living_arrangement'] == 'Living Alone']['health_outcomes_score'].dropna()
with_family = elderly_df[elderly_df['living_arrangement'] == 'With Family']['health_outcomes_score'].dropna()

t_stat, p_value = ttest_ind(alone, with_family, equal_var=False)

print(f"T-statistic: {t_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print(f"\nMean scores:")
    print(f"  Living Alone: {alone.mean():.2f}")
    print(f"  With Family: {with_family.mean():.2f}")

# Test 1.3: Social Context by Age Group
print("\n" + "-"*80)
print("Test 1.3: Social Context by Age Group (One-way ANOVA)")
print("-"*80)

groups_age_social = [elderly_df[elderly_df['age_group'] == ag]['social_context_score'].dropna()
                     for ag in ['60-69', '70-79', '80+']]
f_stat, p_value = f_oneway(*groups_age_social)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by age group:")
    for ag in ['60-69', '70-79', '80+']:
        mean_score = elderly_df[elderly_df['age_group'] == ag]['social_context_score'].mean()
        print(f"  {ag}: {mean_score:.2f}")

# Test 1.4: Social Context by Living Arrangement
print("\n" + "-"*80)
print("Test 1.4: Social Context by Living Arrangement (T-Test)")
print("-"*80)

alone_social = elderly_df[elderly_df['living_arrangement'] == 'Living Alone']['social_context_score'].dropna()
with_family_social = elderly_df[elderly_df['living_arrangement'] == 'With Family']['social_context_score'].dropna()

t_stat, p_value = ttest_ind(alone_social, with_family_social, equal_var=False)

print(f"T-statistic: {t_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print(f"\nMean scores:")
    print(f"  Living Alone: {alone_social.mean():.2f}")
    print(f"  With Family: {with_family_social.mean():.2f}")

# ============================================================================
# ANALYSIS 2: DISABLED GROUP
# ============================================================================

print("\n" + "="*80)
print("ANALYSIS 2: DISABLED GROUP (disable_status == 1)")
print("="*80)

disabled_df = survey_df[survey_df['is_disabled']].copy()
print(f"Total disabled respondents: {len(disabled_df):,}")

# Education Level Categories
def categorize_education(edu):
    if pd.isna(edu) or edu in [0, 1, 2]:
        return 'Primary/None'
    elif edu in [3, 4, 5, 6]:
        return 'Secondary'
    else:
        return 'Bachelor+'

disabled_df['education_level'] = disabled_df['education'].apply(categorize_education)

print("\nEducation level distribution:")
print(disabled_df['education_level'].value_counts())

# Test 2.1: Economic Security by Education Level
print("\n" + "-"*80)
print("Test 2.1: Economic Security by Education Level (One-way ANOVA)")
print("-"*80)

groups_edu = [disabled_df[disabled_df['education_level'] == level]['economic_security_score'].dropna()
              for level in ['Primary/None', 'Secondary', 'Bachelor+']]

f_stat, p_value = f_oneway(*groups_edu)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by education level:")
    for level in ['Primary/None', 'Secondary', 'Bachelor+']:
        mean_score = disabled_df[disabled_df['education_level'] == level]['economic_security_score'].mean()
        count = len(disabled_df[disabled_df['education_level'] == level])
        print(f"  {level}: {mean_score:.2f} (n={count})")

# ============================================================================
# ANALYSIS 3: INFORMAL WORKERS GROUP
# ============================================================================

print("\n" + "="*80)
print("ANALYSIS 3: INFORMAL WORKERS GROUP")
print("="*80)

informal_df = survey_df[survey_df['is_informal']].copy()
print(f"Total informal workers: {len(informal_df):,}")

# Income Quartiles
informal_df['income_quartile'] = pd.qcut(informal_df['monthly_income'].dropna(),
                                          q=3, labels=['Low', 'Middle', 'High'],
                                          duplicates='drop')

# Education Level
informal_df['education_level'] = informal_df['education'].apply(categorize_education)

print("\nIncome quartile distribution:")
print(informal_df['income_quartile'].value_counts())
print("\nEducation level distribution:")
print(informal_df['education_level'].value_counts())

# Test 3.1: Economic Security by Income Quartile
print("\n" + "-"*80)
print("Test 3.1: Economic Security by Income Quartile (One-way ANOVA)")
print("-"*80)

groups_income = [informal_df[informal_df['income_quartile'] == q]['economic_security_score'].dropna()
                 for q in ['Low', 'Middle', 'High']]

f_stat, p_value = f_oneway(*groups_income)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by income quartile:")
    for q in ['Low', 'Middle', 'High']:
        mean_score = informal_df[informal_df['income_quartile'] == q]['economic_security_score'].mean()
        count = len(informal_df[informal_df['income_quartile'] == q])
        print(f"  {q}: {mean_score:.2f} (n={count})")

# Test 3.2: Economic Security by Education Level
print("\n" + "-"*80)
print("Test 3.2: Economic Security by Education Level (One-way ANOVA)")
print("-"*80)

groups_edu_informal = [informal_df[informal_df['education_level'] == level]['economic_security_score'].dropna()
                       for level in ['Primary/None', 'Secondary', 'Bachelor+']]

f_stat, p_value = f_oneway(*groups_edu_informal)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by education level:")
    for level in ['Primary/None', 'Secondary', 'Bachelor+']:
        mean_score = informal_df[informal_df['education_level'] == level]['economic_security_score'].mean()
        count = len(informal_df[informal_df['education_level'] == level])
        print(f"  {level}: {mean_score:.2f} (n={count})")

# Test 3.3: Healthcare Access by Income Quartile
print("\n" + "-"*80)
print("Test 3.3: Healthcare Access by Income Quartile (One-way ANOVA)")
print("-"*80)

groups_income_health = [informal_df[informal_df['income_quartile'] == q]['healthcare_access_score'].dropna()
                        for q in ['Low', 'Middle', 'High']]

f_stat, p_value = f_oneway(*groups_income_health)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by income quartile:")
    for q in ['Low', 'Middle', 'High']:
        mean_score = informal_df[informal_df['income_quartile'] == q]['healthcare_access_score'].mean()
        count = len(informal_df[informal_df['income_quartile'] == q])
        print(f"  {q}: {mean_score:.2f} (n={count})")

# Test 3.4: Healthcare Access by Education Level
print("\n" + "-"*80)
print("Test 3.4: Healthcare Access by Education Level (One-way ANOVA)")
print("-"*80)

groups_edu_health = [informal_df[informal_df['education_level'] == level]['healthcare_access_score'].dropna()
                     for level in ['Primary/None', 'Secondary', 'Bachelor+']]

f_stat, p_value = f_oneway(*groups_edu_health)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by education level:")
    for level in ['Primary/None', 'Secondary', 'Bachelor+']:
        mean_score = informal_df[informal_df['education_level'] == level]['healthcare_access_score'].mean()
        count = len(informal_df[informal_df['education_level'] == level])
        print(f"  {level}: {mean_score:.2f} (n={count})")

# ============================================================================
# ANALYSIS 4: LGBTQ+ GROUP
# ============================================================================

print("\n" + "="*80)
print("ANALYSIS 4: LGBTQ+ GROUP (sex == 'lgbt')")
print("="*80)

lgbt_df = survey_df[survey_df['is_lgbt']].copy()
print(f"Total LGBTQ+ respondents: {len(lgbt_df):,}")

# Generation Categories
def categorize_generation(age):
    if pd.isna(age):
        return np.nan
    if 18 <= age <= 27:
        return 'Gen Z (18-27)'
    elif 28 <= age <= 43:
        return 'Gen Y (28-43)'
    elif age >= 44:
        return 'Gen X/Boomers (44+)'
    return np.nan

lgbt_df['generation'] = lgbt_df['age'].apply(categorize_generation)

print("\nGeneration distribution:")
print(lgbt_df['generation'].value_counts())

# Test 4.1: Healthcare Access by Generation
print("\n" + "-"*80)
print("Test 4.1: Healthcare Access by Generation (One-way ANOVA)")
print("-"*80)

groups_gen_health = [lgbt_df[lgbt_df['generation'] == gen]['healthcare_access_score'].dropna()
                     for gen in ['Gen Z (18-27)', 'Gen Y (28-43)', 'Gen X/Boomers (44+']]

f_stat, p_value = f_oneway(*groups_gen_health)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by generation:")
    for gen in ['Gen Z (18-27)', 'Gen Y (28-43)', 'Gen X/Boomers (44+']:
        mean_score = lgbt_df[lgbt_df['generation'] == gen]['healthcare_access_score'].mean()
        count = len(lgbt_df[lgbt_df['generation'] == gen])
        print(f"  {gen}: {mean_score:.2f} (n={count})")

# Test 4.2: Social Context by Generation
print("\n" + "-"*80)
print("Test 4.2: Social Context by Generation (One-way ANOVA)")
print("-"*80)

groups_gen_social = [lgbt_df[lgbt_df['generation'] == gen]['social_context_score'].dropna()
                     for gen in ['Gen Z (18-27)', 'Gen Y (28-43)', 'Gen X/Boomers (44+']]

f_stat, p_value = f_oneway(*groups_gen_social)

print(f"F-statistic: {f_stat:.4f}")
print(f"p-value: {p_value:.6f}")
print(f"Significant: {'Yes' if p_value < 0.05 else 'No'}")

if p_value < 0.05:
    print("\nMean scores by generation:")
    for gen in ['Gen Z (18-27)', 'Gen Y (28-43)', 'Gen X/Boomers (44+']:
        mean_score = lgbt_df[lgbt_df['generation'] == gen]['social_context_score'].mean()
        count = len(lgbt_df[lgbt_df['generation'] == gen])
        print(f"  {gen}: {mean_score:.2f} (n={count})")

print("\n" + "="*80)
print("INTRA-GROUP ANALYSIS COMPLETE")
print("="*80)
print("\nNote: Only statistically significant results (p<0.05) are shown in detail above.")
